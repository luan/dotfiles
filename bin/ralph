#!/bin/bash

show_help() {
    cat <<'EOF'
ralph - Automated Claude Code Execution Loop

SYNOPSIS
    ralph [-i iterations] [-m model] [-d directory] [-c cli] [-h] <mode>

DESCRIPTION
    Ralph orchestrates automated coding loops with Claude Code, reading prompts
    from markdown files and executing them iteratively. Perfect for autonomous
    development workflows.

MODES
    build       Build mode - executes PROMPT_build.md
                Default model: sonnet (faster, ideal for well-defined tasks)

    plan        Plan mode - executes PROMPT_plan.md
                Default model: opus (more thorough, ideal for planning)

OPTIONS
    -i <num>    Maximum number of iterations (default: 5)
                Set to 0 for unlimited iterations.

    -m <model>  AI model to use: opus, sonnet, or haiku
                Defaults: opus for plan mode, sonnet for build mode.

    -d <dir>    Directory containing PROMPT_*.md files (default: .)
                Ralph will look for PROMPT_<mode>.md in this directory.

    -c <cli>    Claude CLI command or path (default: claude)
                Use this to specify a custom claude binary location.

    -t         Enable TUI mode (text user interface from Claude) instead
               of headless, requires manual exit each iteration.

    -h          Show this help message and exit

BEHAVIOR
    Each iteration:
    1. Reads the prompt file (PROMPT_<mode>.md)
    2. Pipes it to Claude Code in headless mode
    3. Auto-approves all tool calls (--dangerously-skip-permissions)
    4. Pushes changes to the current git branch
    5. Repeats until max iterations reached

    The loop continues autonomously, allowing Claude to complete multi-step
    tasks without manual intervention.

FILES
    PROMPT_build.md     Prompt file for build mode
    PROMPT_plan.md      Prompt file for plan mode

EXAMPLES
    # Basic usage - 5 iterations of build mode with sonnet
    ralph build

    # Plan mode with 10 iterations using opus
    ralph -i 10 plan

    # Fast prototyping with haiku
    ralph -m haiku build

    # Custom directory and unlimited iterations
    ralph -d ./prompts -i 0 plan

    # Full configuration
    ralph -i 20 -m opus -d ./my-prompts -c /usr/local/bin/claude build

ENVIRONMENT
    Requires:
    - claude CLI (Claude Code) in PATH or specified via -c
    - Git repository (for automatic pushing)
    - PROMPT_*.md files in the working directory

    Optional:
    - ralph-format.py for pretty output (always used if available)
    - delta for enhanced diff visualization in formatted output

NOTES
    - Ralph runs in YOLO mode (--dangerously-skip-permissions)
    - Each iteration auto-pushes to the current branch
    - Use Ctrl+C to stop the loop early
    - Hook outputs are suppressed for cleaner output

VERSION
    ralph automation suite v1.0

EOF
    exit 0
}

# Default values
MAX_ITERATIONS=5
RALPH_DIR="."
MODEL=""
CLI="claude"
TUI="false"

# Parse flags
while getopts "i:m:d:c:th" opt; do
    case $opt in
    i) MAX_ITERATIONS="$OPTARG" ;;
    m) MODEL="$OPTARG" ;;
    d) RALPH_DIR="$OPTARG" ;;
    c) CLI="$OPTARG" ;;
    t) TUI="true" ;;
    h)
        show_help
        ;;
    *)
        echo "Error: Invalid option"
        echo "Try 'ralph -h' for more information."
        exit 1
        ;;
    esac
done
shift $((OPTIND - 1))

# Require mode
MODE=$1
if [[ "$MODE" != "build" && "$MODE" != "plan" ]]; then
    echo "Error: Mode must be 'build' or 'plan'"
    echo "Try 'ralph -h' for more information."
    exit 1
fi

# Set defaults based on mode if not provided
if [ -z "$MODEL" ]; then
    if [ "$MODE" = "plan" ]; then
        MODEL="opus"
    else
        MODEL="sonnet"
    fi
fi

PROMPT_FILE="$RALPH_DIR/PROMPT_$MODE.md"

# Verify prompt file exists
if [ ! -f "$PROMPT_FILE" ]; then
    echo "Error: $PROMPT_FILE not found"
    exit 1
fi

ITERATION=1
CURRENT_BRANCH=$(git branch --show-current)

# Export for ralph-format.py
export RALPH_MODE="$MODE"
export RALPH_PROMPT="$PROMPT_FILE"
export RALPH_MODEL="$MODEL"
export RALPH_BRANCH="$CURRENT_BRANCH"
export RALPH_MAX_ITERATIONS="$MAX_ITERATIONS"

while true; do
    if [ $MAX_ITERATIONS -gt 0 ] && [ $ITERATION -gt $MAX_ITERATIONS ]; then
        echo "Reached max iterations: $MAX_ITERATIONS"
        break
    fi

    export RALPH_ITERATION="$ITERATION"

    # Run Ralph iteration with selected prompt
    # -p: Headless mode
    # --dangerously-skip-permissions: Auto-approve all tool calls
    # --output-format=stream-json: Structured output
    # --model: Selected model
    # --verbose: Detailed logging
    if [ "$TUI" = "true" ]; then
        "$CLI" --dangerously-skip-permissions --model "$MODEL" "$(cat "$PROMPT_FILE")"
    else
        cat "$PROMPT_FILE" | "$CLI" -p --dangerously-skip-permissions --output-format=stream-json --model "$MODEL" --verbose | ralph-format.py
    fi

    ITERATION=$((ITERATION + 1))
done
